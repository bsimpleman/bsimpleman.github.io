<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Personal Portfolio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="prism.css">
</head>
<body>
<div id="header">
    <h1>Blake's Code Portfolio</h1>
</div>
<div id="main-container">
    <div class="paragraph-sm">
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Varius morbi enim nunc faucibus a pellentesque sit. At elementum eu facilisis sed odio morbi quis commodo odio. Sed felis eget velit aliquet sagittis id consectetur purus ut. Suspendisse potenti nullam ac tortor vitae purus faucibus. Sagittis orci a scelerisque purus semper eget duis at. Habitant morbi tristique senectus et netus et. Imperdiet sed euismod nisi porta lorem mollis aliquam ut porttitor. At urna condimentum mattis pellentesque id nibh tortor. Viverra suspendisse potenti nullam ac. Quis vel eros donec ac. Gravida quis blandit turpis cursus in. Ultricies tristique nulla aliquet enim tortor at auctor urna nunc.
        </p>
    </div>
    <div class="codeblock-sm">
        <pre class="line-numbers"><code class="language-js">const mongoConnection = require("../utils/database");

const readLeaderboard = async (req, res) => {
    let numRequested = -1;
    // Check is a top amount of users was specified
    if (req.query.top) {
        numRequested = req.query.top;
    }
    const data = await getLeaderboardData();
    // If there was a top amount of users requested only send back those, otherwise send back every user sorted
    if (numRequested !== -1) {
        const result = await getTopUsers(data, numRequested);
        res.send(result);
    } else {
        res.send(data);
    }
}

const getLeaderboardData = async () => {
    const db = mongoConnection.getDb();
    const userList = [];
    // Passing in an empty object for the search parameter in find() gives back every item in the collection
    const users = await db.collection('users').find({}).toArray();
    await users.forEach((user) => {
        // Only users who have opted to share their information should be included
        if (user.isPrivate === false) {
            userList.push({
                "username": user.username,
                "allTimeFunds": user.allTimeFunds,
                "profileImg": user.profileImg
            });
        }
    })
    const sortedList = (await sortUserList(userList))
    const result = await sortedList;
    return result;
}

const sortUserList = async (userList) => {
    // Sorts the returned user objects by their allTimeFunds
    userList.sort((a,b) => (a.allTimeFunds < b.allTimeFunds) ? 1 : -1);
    return userList;
}

const getTopUsers = async (data, numRequested) => {
    // Uses the "top" query to make an array containing only the amount of users requested
    const result = [];
    for (let i = 0; i < numRequested; i++) {
        result.push(data[i]);
    }
    return result;
}

module.exports = {
    readLeaderboard
}</code></pre>
    </div>
    <div class="paragraph-sm">
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Varius morbi enim nunc faucibus a pellentesque sit. At elementum eu facilisis sed odio morbi quis commodo odio. Sed felis eget velit aliquet sagittis id consectetur purus ut. Suspendisse potenti nullam ac tortor vitae purus faucibus. Sagittis orci a scelerisque purus semper eget duis at. Habitant morbi tristique senectus et netus et. Imperdiet sed euismod nisi porta lorem mollis aliquam ut porttitor. At urna condimentum mattis pellentesque id nibh tortor. Viverra suspendisse potenti nullam ac. Quis vel eros donec ac. Gravida quis blandit turpis cursus in. Ultricies tristique nulla aliquet enim tortor at auctor urna nunc.
        </p>
        <br>
        <p>Imperdiet dui accumsan sit amet nulla. Nibh tortor id aliquet lectus proin. Ut venenatis tellus in metus vulputate eu scelerisque. Morbi blandit cursus risus at ultrices mi tempus imperdiet. Leo vel orci porta non. Amet porttitor eget dolor morbi non arcu risus quis varius. Sagittis eu volutpat odio facilisis mauris sit amet. Praesent elementum facilisis leo vel fringilla. Viverra adipiscing at in tellus integer feugiat scelerisque. Diam volutpat commodo sed egestas egestas fringilla. Lacus suspendisse faucibus interdum posuere lorem ipsum dolor sit.</p>
    </div>
    <div class="codeblock-sm">
        <pre class="line-numbers"><code class="language-js">
            const jsonBody = {
                "username": "",
                "name": "",
                "bio": "",
                "email": "",
                "age": 0,
                "password": "",
                "profileImg": "ducky",
                "phoneNumber": 4029490831,
                "messagingPoints": 100,
                "allTimeFunds": 0,
                "funds": 0,
                "inventoryId": "",
                "lastLogin": "",
                "isPrivate": false,
                "notifications" : false,
                "trophies": []
            }

            // Names can only be characters a-z
            export function verifyName(name) {
                if ([...name].length === 0) {
                    return "Please input a name!"
                } else if ([...name].length > 40) {
                    return "Names must be under 40 characters long"
                } else if (!name.match(/^[-_ a-zA-Z]+$/)) {
                    return "Invalid name. Only characters a-z are allowed"
                } else {
                    return true;
                }
            }

            export function verifyUsername(username) {
                if ([...username].length === 0) {
                    return "Please input a username!"
                } else if ([...username].length > 30) {
                    return "Usernames must be under 30 characters long"
                } else if (!username.match(/^[0-9A-Za-z]+$/)) {
                    return "Invalid username. Only letters and numbers are allowed"
                } else {
                    return true;
                }
            }

            export function verifyEmail(email) {
                if ([...email].length === 0) {
                    return "Please input an email!"
                } else if (!(/\S+@\S+\.\S+/.test(email))) {
                    return "Invalid email!"
                } else {
                    return true;
                }
            }

            export function verifyPassword(password) {
                if ([...password].length < 8){
                    return "Password is too short! It must be at least 8 characters long"
                } else if ([...password].length > 30) {
                    return "Passwords must be under 30 characters long"
                } else if (!password.match("^[a-zA-Z0-9!@#$&()\\-`.+,/\"]*$")) {
                    return "Invalid password. Only characters a-z, 0-9, and special characters excluding spaces are allowed"
                } else if (!(/\d/.test(password))) {
                    return "Password must contain a number"
                } else if (password.toLowerCase() === password) {
                    return "Password must contain a capital letter"
                } else {
                    return true;
                }
            }

            export async function isExistingUsername(username) {
                const users = await fetch('http://localhost:8080/api/existingUser?username=' + username);
                const response = await users;
                return response.status;
            }

            export async function isExistingEmail(email) {
                const emails = await fetch('http://localhost:8080/api/existingEmail?email=' + email);
                const response = await emails;
                return response.status;
            }

            export async function createUser(name, username, email, password) {
                // Populate fields of our JSON object with the collected information
                jsonBody.name = name;
                jsonBody.username = username;
                jsonBody.email = email;
                jsonBody.password = password;

                const newUserJSON = JSON.stringify(jsonBody);

                // Send JSON data into POST request
                const response = await fetch("http://localhost:8080/api/signup", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: newUserJSON
                });
                const responseData = await response.json();

                // handle session authentication using the response information
                localStorage.setItem('token', responseData.token);
            }
        </code></pre>
    </div>
</div>
<script src="prism.js"></script>
</body>
</html>